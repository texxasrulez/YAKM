<?php
declare(strict_types=1);

/**
 * Kontact • Installer (Setup Wizard)
 * Standalone installer: no project includes. Writes config and creates tables.
 */

if (\session_status() !== \PHP_SESSION_ACTIVE) { @\session_start(); }
$errors = [];
$done = false;

function h($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }
function postv($k,$d=''){ return isset($_POST[$k]) ? trim((string)$_POST[$k]) : $d; }

// i18n bootstrap for standalone installer
$i18n_file = __DIR__ . '/../localization/i18n.php';
if (is_file($i18n_file)) {
    require_once $i18n_file;
} else {
    if (!function_exists('tr')) { function tr($k, $d = null) { return $d ?? $k; } }
    if (!function_exists('_e')) { function _e($k, $d = null) { echo tr($k, $d); } }
}

if (empty($_SESSION['setup_csrf'])) { $_SESSION['setup_csrf'] = bin2hex(random_bytes(16)); }
$csrf = $_SESSION['setup_csrf'];

$cfg_path = __DIR__ . '/../config/config.inc.php';
$have_existing_cfg = is_file($cfg_path);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!hash_equals($_SESSION['setup_csrf'], $_POST['csrf'] ?? '')) {
        $errors[] = tr('invalid_csrf_token','Invalid CSRF token. Refresh and try again.');
    } else {
        $DB_HOST = postv('DB_HOST','localhost');
        $DB_NAME = postv('DB_NAME','');
        $DB_USER = postv('DB_USER','');
        $DB_PASS = (string)($_POST['DB_PASS'] ?? '');
        $admin_email = postv('admin_email','');
        $admin_pass  = (string)($_POST['admin_pass'] ?? '');

        $webmaster   = postv('WEBMASTER_EMAIL','');
        $site_name   = postv('SITE_NAME','Kontact');
        $site_url    = postv('SITE_URL','');
        $site_logo   = postv('SITE_LOGO','/assets/images/logo.png');
        $form_title  = postv('FORM_TITLE','Visitor');
        $form_name   = postv('FORM_NAME','Contact');

        if ($DB_HOST==='' || $DB_NAME==='' || $DB_USER==='') { $errors[] = tr('db_host_name_user_reqd','DB host, name, and user are required.'); }
        if (!filter_var($admin_email, FILTER_VALIDATE_EMAIL)) { $errors[] = tr('admin_email_invalid','Admin email is invalid.'); }
        if (strlen($admin_pass) < 8) { $errors[] = tr('admin_password_must_be_eight','Admin password must be at least 8 characters.'); }

        if (!$errors) {
            try {
                $pdo = new \PDO("mysql:host=".$DB_HOST.";dbname=".$DB_NAME.";charset=utf8mb4", $DB_USER, $DB_PASS, [
                    \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
                    \PDO::ATTR_DEFAULT_FETCH_MODE => \PDO::FETCH_ASSOC,
                ]);

                // Tables
                $pdo->exec("CREATE TABLE IF NOT EXISTS kontact_admins (
                  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  email VARCHAR(190) NOT NULL UNIQUE,
                  password_hash VARCHAR(255) NOT NULL,
                  role VARCHAR(32) NOT NULL DEFAULT 'admin',
                  is_active TINYINT(1) NOT NULL DEFAULT 1,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  last_login_at TIMESTAMP NULL
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                $pdo->exec("CREATE TABLE IF NOT EXISTS kontact_password_resets (
                  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  admin_id BIGINT NOT NULL,
                  token VARCHAR(64) NOT NULL UNIQUE,
                  expires_at TIMESTAMP NOT NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  INDEX (admin_id)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                $pdo->exec("CREATE TABLE IF NOT EXISTS kontact_settings (
                  `key` VARCHAR(128) NOT NULL PRIMARY KEY,
                  `value` TEXT NULL
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                $pdo->exec("CREATE TABLE IF NOT EXISTS kontact_templates (
                  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  name VARCHAR(100) NOT NULL UNIQUE,
                  subject VARCHAR(255) NOT NULL,
                  body_html MEDIUMTEXT NOT NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                $pdo->exec("CREATE TABLE IF NOT EXISTS kontact_blocklist (
                  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  ip VARCHAR(64) NOT NULL,
                  reason VARCHAR(255) NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  expires_at TIMESTAMP NULL,
                  UNIQUE KEY uniq_ip (ip)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                $pdo->exec("CREATE TABLE IF NOT EXISTS kontact_audit (
                  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  event_type VARCHAR(64) NOT NULL,
                  ip VARCHAR(64) NULL,
                  user_agent VARCHAR(255) NULL,
                  detail VARCHAR(255) NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                $pdo->exec("CREATE TABLE IF NOT EXISTS kontacts (
                  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  name VARCHAR(255) NULL,
                  subject VARCHAR(255) NULL,
                  email VARCHAR(255) NULL,
                  message MEDIUMTEXT NULL,
                  user_ip VARCHAR(64) NULL,
                  user_id VARCHAR(64) NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

                // Seed admin
                $has = (int)$pdo->query("SELECT COUNT(*) FROM kontact_admins")->fetchColumn();
                if ($has === 0) {
                    $ph = \password_hash($admin_pass, \PASSWORD_DEFAULT);
                    $st = $pdo->prepare("INSERT INTO kontact_admins(email,password_hash,role,is_active) VALUES(?,?,'owner',1)");
                    $st->execute([$admin_email, $ph]);
                }

                // Settings
                $ins = $pdo->prepare("INSERT INTO kontact_settings(`key`,`value`) VALUES(?,?) ON DUPLICATE KEY UPDATE value=VALUES(value)");
                foreach ([
                    'WEBMASTER_EMAIL' => $webmaster,
                    'SITE_NAME' => $site_name,
                    'SITE_URL'  => $site_url,
                    'SITE_LOGO' => $site_logo,
                    'FORM_TITLE'=> $form_title,
                    'FORM_NAME' => $form_name,
                    'MIGRATION_LAST_RAN' => date('c'),
                ] as $k=>$v) { $ins->execute([$k, $v]); }

                // Write config
                $cfg = [
                    'DB_HOST' => $DB_HOST,
                    'DB_NAME' => $DB_NAME,
                    'DB_USER' => $DB_USER,
                    'DB_PASS' => $DB_PASS,
                    // Compatibility
                    'DATABASE_HOST' => $DB_HOST,
                    'DATABASE_NAME' => $DB_NAME,
                    'DATABASE_USER' => $DB_USER,
                    'DATABASE_PASS' => $DB_PASS,

                    'DATABASE_TABLE' => 'kontacts',

                    'SITE_NAME'  => $site_name,
                    'SITE_URL'   => $site_url,
                    'SITE_LOGO'  => $site_logo,
                    'FORM_TITLE' => $form_title,
                    'FORM_NAME'  => $form_name,

                    'WEBMASTER_EMAIL' => $webmaster,
                    'RECIPIENT_MODE'  => 'single',
                    'RECIPIENTS_JSON' => '[]',
                    'EMAIL_THEME'     => 'stylish_theme.php',
                    'AUTO_REPLY_ENABLE'   => '0',
                    'AUTO_REPLY_TEMPLATE' => 'auto_reply_ack',

                    'ENABLE_SMTP' => '0',
                    'SMTP_HOST'   => '',
                    'SMTP_PORT'   => '587',
                    'SMTP_USER'   => '',
                    'SMTP_PASS'   => '',
                    'SMTP_SECURE' => 'tls',
                    'FROM_EMAIL'  => $webmaster ?: '',
                    'FROM_NAME'   => $site_name ?: 'Kontact',

                    'MIN_SUBMIT_SECONDS' => '3',
                ];
                $export  = "<?php\nreturn " . var_export($cfg, true) . ";\n";
                $export .= "\n// Back-compat\n\$GLOBALS['cfg'] = " . var_export($cfg, true) . ";\n";
                if (!is_dir(dirname($cfg_path))) { mkdir(dirname($cfg_path), 0775, true); }
                if (false === file_put_contents($cfg_path, $export)) {
                    throw new \RuntimeException('Failed to write config.inc.php');
                }
                @chmod($cfg_path, 0640);

                if (basename(__FILE__) === 'setup.php') { @rename(__FILE__, __DIR__ . '/setup.php.sample'); }
                $done = true;
            } catch (\Throwable $e) {
                $errors[] = $e->getMessage();
            }
        }
    }
}
?>
<!doctype html>
<?php
$lang = 'en-US';
if (function_exists('kontact_current_locale')) {
    $lang = str_replace('_','-', (string)kontact_current_locale());
}
?>
<html lang="<?= h($lang) ?>">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../assets/css/admin.css">
<title><?php _e('first_run_setup','First-run Setup • Kontact'); ?></title>
</head>
<body>
<div class="container">
  <div class="card">
    <?php if ($done): ?>
      <h2><?php _e('setup_complete','Setup Complete'); ?></h2>
      <p><?php _e('admin_created_tables_config','Admin created, tables ensured, and configuration written.'); ?></p>
      <p><?php _e('installer_renamed','The installer has been renamed to kontact/admin/setup.php.sample for safety. Keep it as your original to rename when needed.'); ?></p>
      <p><a class="btn" href="login.php"><?php _e('go_to_login','Go to Login'); ?></a></p>
    <?php else: ?>
      <h2>First-run Setup</h2>
      <?php if ($have_existing_cfg): ?>
        <p class="notice"><?php _e('config_exists','A config.inc.php already exists; completing this wizard will overwrite DB creds and some defaults.'); ?></p>
      <?php endif; ?>
      <?php if (!empty($errors)): ?>
        <div class="flash error">
          <ul><?php foreach ($errors as $e): ?><li><?=h($e)?></li><?php endforeach; ?></ul>
        </div>
      <?php endif; ?>

      <form method="post">
        <input type="hidden" name="csrf" value="<?=$csrf?>">

        <h3><?php _e('database','Database'); ?></h3>
        <div class="input-row">
          <label><?php _e('db_host','DB Host'); ?>
            <input required name="DB_HOST" value="<?=h(postv('DB_HOST','localhost'))?>">
          </label>
          <label><?php _e('db_name','DB Name'); ?>
            <input required name="DB_NAME" value="<?=h(postv('DB_NAME',''))?>">
          </label>
        </div>
        <div class="input-row">
          <label><?php _e('db_user','DB User'); ?>
            <input required name="DB_USER" value="<?=h(postv('DB_USER',''))?>">
          </label>
          <label><?php _e('db_pass','DB Pass'); ?>
            <input type="password" name="DB_PASS" value="">
          </label>
        </div>

        <h3><?php _e('admin_account','Admin Account'); ?></h3>
        <div class="input-row">
          <label><?php _e('admin_email','Admin Email'); ?>
            <input required type="email" name="admin_email" value="<?=h(postv('admin_email',''))?>">
          </label>
          <label><?php _e('admin_password','Admin Password'); ?>
            <input required type="password" name="admin_pass" value="">
          </label>
        </div>

        <h3><?php _e('site_and_email','Site & Email'); ?></h3>
        <div class="input-row">
          <label><?php _e('webmaster_email','Webmaster Email'); ?>
            <input type="email" name="WEBMASTER_EMAIL" value="<?=h(postv('WEBMASTER_EMAIL',''))?>">
          </label>
          <label><?php _e('site_name','Site Name'); ?>
            <input name="SITE_NAME" value="<?=h(postv('SITE_NAME','Kontact'))?>">
          </label>
        </div>
        <div class="input-row">
          <label><?php _e('site_url','Site URL'); ?>
            <input type="url" name="SITE_URL" value="<?=h(postv('SITE_URL',''))?>">
          </label>
          <label><?php _e('site_logo_path','Site Logo Path'); ?>
            <input name="SITE_LOGO" value="<?=h(postv('SITE_LOGO','/assets/images/logo.png'))?>">
          </label>
        </div>
        <div class="input-row">
          <label><?php _e('form_title','Form Title'); ?>
            <input name="FORM_TITLE" value="<?=h(postv('FORM_TITLE','Visitor'))?>">
          </label>
          <label><?php _e('form_name','Form Name'); ?>
            <input name="FORM_NAME" value="<?=h(postv('FORM_NAME','Contact'))?>">
          </label>
        </div>

        <p><button class="btn"><?php _e('finish_setup','Finish Setup'); ?></button></p>
      </form>
    <?php endif; ?>
  </div>
</div>
</body>
</html>
