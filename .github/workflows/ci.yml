name: CI

on: [push, pull_request]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  php:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: [ '8.2', '8.3' ]

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.php-version }}-

      - name: Validate composer.json
        if: hashFiles('**/composer.json') != ''
        run: composer validate --strict

      - name: Install dependencies (with dev)
        if: hashFiles('**/composer.json') != ''
        run: composer install --no-interaction --prefer-dist

      - name: PHP syntax lint
        run: |
          set -e
          mapfile -t files < <(git ls-files '*.php')
          if [ "${#files[@]}" -gt 0 ]; then
            for f in "${files[@]}"; do
              php -l "$f"
            done
          else
            echo "No PHP files found; skipping lint"
          fi

      - name: Static analysis (phpstan) if present
        run: |
          if [ -x vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --no-progress
          elif [ -x vendor/bin/phpstan.phar ]; then
            vendor/bin/phpstan.phar analyse --no-progress
          else
            echo "phpstan not found; skipping"
          fi

      - name: Coding style (php-cs-fixer/phpcbf) if present
        run: |
          if [ -x vendor/bin/php-cs-fixer ]; then
            vendor/bin/php-cs-fixer --version
            vendor/bin/php-cs-fixer check --diff || true
          elif [ -x vendor/bin/phpcbf ]; then
            vendor/bin/phpcbf --version
            vendor/bin/phpcbf || true
          else
            echo "style tool not found; skipping"
          fi

      - name: Tests (phpunit) if present
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit --testdox
          else
            echo "phpunit not found; skipping"
          fi

      - name: Composer security advisories (if composer.json exists)
        if: hashFiles('**/composer.json') != ''
        run: composer audit --no-interaction || true
