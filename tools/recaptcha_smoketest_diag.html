<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>reCAPTCHA Enterprise Smoke Test — Diagnostic</title>
  <!-- IMPORTANT: Replace YOUR_SITE_KEY below -->
  <script id="grecap-loader" src="https://www.google.com/recaptcha/enterprise.js?render=YOUR_SITE_KEY"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    pre { white-space: pre-wrap; background: #0b1020; color: #d3e3ff; padding: 1rem; border-radius: 8px; }
    .ok { color: #198754; } .warn { color: #fd7e14; } .err { color: #dc3545; }
    button { padding: .6rem 1rem; } .row { margin-bottom: 1rem; }
    code { background:#f6f8fa; padding:.2rem .4rem; border-radius:4px; }
  </style>
</head>
<body>
  <h1>reCAPTCHA Enterprise Smoke Test — Diagnostic</h1>
  <ol>
    <li>Replace <code>YOUR_SITE_KEY</code> in the script tag URL with your real Site Key.</li>
    <li>Open DevTools → Console. Reload this page. Watch logs below.</li>
    <li>Click <b>Execute &amp; Verify</b>. A token should appear, then server response.</li>
  </ol>

  <div class="row">
    <label>Action value:
      <input id="action" value="submit">
    </label>
  </div>
  <div class="row">
    <button id="btn">Execute &amp; Verify</button>
  </div>

  <h3>Environment Checks</h3>
  <pre id="envBox">(running checks...)</pre>

  <h3>Token</h3>
  <pre id="tokenBox">(none)</pre>

  <h3>Assessment Response</h3>
  <pre id="respBox">(none)</pre>

<script>
(function(){
  const envBox = document.getElementById('envBox');
  const tokenBox = document.getElementById('tokenBox');
  const respBox = document.getElementById('respBox');

  function logEnv(lines){ envBox.textContent = lines.join('\n'); }
  function ok(s){ return "✔ " + s; }
  function warn(s){ return "⚠ " + s; }
  function err(s){ return "✘ " + s; }

  function checkEnv(){
    const lines = [];
    const loader = document.getElementById('grecap-loader');
    const siteKey = (loader && loader.src && (loader.src.split('render=')[1]||'').split('&')[0]) || '';
    lines.push(siteKey ? ok("Loader has site key: " + siteKey) : err("Loader missing site key. Edit the script URL."));
    lines.push(location.protocol === 'https:' ? ok("Page is HTTPS") : warn("Page is not HTTPS (tokens may still generate, but production should be HTTPS)."));
    lines.push(ok("User-Agent: " + navigator.userAgent));
    lines.push(ok("Hostname: " + location.hostname));
    lines.push(("grecaptcha" in window) ? ok("window.grecaptcha present") : err("window.grecaptcha is NOT present."));
    try {
      lines.push((window.grecaptcha && grecaptcha.enterprise) ? ok("grecaptcha.enterprise present") : err("grecaptcha.enterprise is NOT present."));
    } catch(e){
      lines.push(err("Accessing grecaptcha threw: " + e));
    }
    logEnv(lines);
  }

  checkEnv();

  document.getElementById('btn').addEventListener('click', function(){
    const loader = document.getElementById('grecap-loader');
    const siteKey = (loader && loader.src && (loader.src.split('render=')[1]||'').split('&')[0]) || '';
    const action = document.getElementById('action').value || 'submit';

    if (!siteKey){
      tokenBox.textContent = "Missing site key in loader URL.";
      return;
    }
    if (!window.grecaptcha || !grecaptcha.enterprise){
      tokenBox.textContent = "grecaptcha.enterprise not available. See Environment Checks above.";
      return;
    }

    tokenBox.textContent = "(requesting token...)";
    respBox.textContent = "(waiting for server...)";
    grecaptcha.enterprise.ready(function(){
      grecaptcha.enterprise.execute(siteKey, {action: action}).then(function(token){
        tokenBox.textContent = token ? token : "(empty token)";
        // POST token to server for assessment
        fetch('test_assess.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'token=' + encodeURIComponent(token) + '&action=' + encodeURIComponent(action)
        }).then(async r => {
          const txt = await r.text();
          respBox.textContent = "HTTP " + r.status + "\n\n" + txt;
        }).catch(err => {
          respBox.textContent = "Fetch error: " + err;
        });
      }).catch(function(err){
        tokenBox.textContent = 'execute() error: ' + (err && (err.message || err.toString()) );
      });
    });
  });
})();
</script>
</body>
</html>
